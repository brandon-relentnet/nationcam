# AGENTS.md

## Project Overview

NationCam — a live camera aggregation platform. React 19 SPA (TanStack Router) served by nginx, backed by a custom Go API (Chi router) with PostgreSQL and Redis. Authentication via self-hosted Logto (OIDC). Deployed via Docker Compose on Coolify.

## Architecture

```
Browser ──▶ nginx (web service)
               │
               ├── /api/*  ──▶  Go API (Chi) ──▶ PostgreSQL + Redis
               │
               ├── /*       ──▶  React SPA (static files, index.html fallback)
               │
               └── auth.nationcam.com ──▶ Logto (self-hosted OIDC) ──▶ logto-db
```

### Services (Docker Compose — 6 total)

| Service    | Image / Build        | Purpose                         | Port  |
| ---------- | -------------------- | ------------------------------- | ----- |
| `postgres` | postgres:17-alpine   | App database (states, videos)   | 5432  |
| `logto-db` | postgres:17-alpine   | Logto's own database            | 5432  |
| `redis`    | redis:7-alpine       | Response cache (5-min TTL)      | 6379  |
| `logto`    | svhd/logto:latest    | OIDC auth server                | 3301  |
| `api`      | ./api (Go, built)    | Custom REST API                 | 8080  |
| `web`      | ./web (nginx + SPA)  | Static frontend + /api/ proxy   | 3000  |

### Auth Flow

1. User clicks "Sign In" on admin page
2. Browser redirects to Logto (`/callback` route handles return)
3. Logto issues access token scoped to API resource (`https://api.nationcam.com`)
4. Frontend sends `Authorization: Bearer <token>` on admin write requests
5. Go API validates JWT via JWKS endpoint (cached 1 hour)
6. Admin role checked for write operations (POST endpoints)

## Commands

### Frontend (from `web/` directory, npm)

```bash
npm run dev          # Vite dev server on port 3000
npm run build        # Production build (outputs to dist/)
npm run preview      # Preview production build
npm run test         # Run vitest
npm run lint         # ESLint check
npm run check        # Prettier write + ESLint fix
```

### Go API (from `api/` directory)

```bash
go build ./...                    # Compile all packages
go run ./cmd/server               # Run the API server locally
go test ./...                     # Run tests (when added)
```

**Important:** Go is installed at `$HOME/.local/go/bin` — you may need:
```bash
export PATH="$HOME/.local/go/bin:$HOME/go/bin:$PATH"
```

### sqlc (from `api/` directory)

```bash
sqlc generate        # Regenerate Go code from SQL queries
```

sqlc binary is at `$HOME/go/bin/sqlc`.

### Docker (from repo root)

```bash
docker compose up -d             # Start all services
docker compose up -d --build     # Rebuild and start
docker compose down              # Stop all services
docker compose logs -f api       # View Go API logs
docker compose logs -f logto     # View Logto logs
```

## Project Structure

```
new-nationcam/                        # Repo root
  AGENTS.md                           # This file
  docker-compose.yml                  # 6 services: postgres, logto-db, redis, logto, api, web
  .env.example                        # Docker env vars template
  .gitignore
  docker/
    app-init.sql                      # PostgreSQL schema (copy of api/sql/schema.sql)
  api/                                # Go API
    go.mod / go.sum
    sqlc.yaml                         # sqlc config (generates internal/db/)
    Dockerfile                        # Multi-stage Go build → alpine runtime
    cmd/
      server/
        main.go                       # Entry point: config, DB pool, Redis, router, HTTP server
    sql/
      schema.sql                      # Source of truth for DB schema
      queries/                        # sqlc query files
        states.sql
        sublocations.sql
        videos.sql
    internal/
      config/config.go                # Env var loading
      cache/redis.go                  # Redis client wrapper (GET/SET/Invalidate)
      db/                             # ⚠️ GENERATED BY sqlc — DO NOT EDIT
        db.go
        models.go
        states.sql.go
        sublocations.sql.go
        videos.sql.go
      middleware/
        auth.go                       # Logto JWT validation via JWKS + RequireAdmin
        cors.go                       # CORS middleware
        logger.go                     # Request logging (slog)
      handler/
        router.go                     # Chi router wiring all routes
        health.go                     # GET /health
        state.go                      # GET/POST /states
        sublocation.go                # GET/POST /sublocations
        video.go                      # GET/POST /videos
        json.go                       # JSON read/write helpers
        cached.go                     # Response caching wrapper
  web/                                # React SPA
    package.json
    Dockerfile                        # Multi-stage: npm build → nginx serve
    nginx.conf                        # SPA + /api/ proxy to Go API
    .env.example                      # Frontend env vars (VITE_LOGTO_*)
    vite.config.ts
    tsconfig.json
    src/
      main.tsx                        # Client-side mount
      router.tsx                      # Router factory
      routeTree.gen.ts                # ⚠️ AUTO-GENERATED — DO NOT EDIT
      styles.css                      # Tailwind v4 + Observatory theme
      components/
        LogtoProvider.tsx             # Logto OIDC config + provider wrapper
        ThemeProvider.tsx             # Dark/light theme context
        Navbar.tsx                    # Main nav
        Footer.tsx                    # 4-column footer
        Button.tsx                    # Generic button
        Dropdown.tsx                  # Custom select
        Reveal.tsx                    # Scroll animation wrapper
        StreamPlayer.tsx             # HLS/MP4 player
        ... (other UI components)
      hooks/
        useAuth.ts                   # Logto auth wrapper (login, logout, getToken)
        useReveal.ts                 # IntersectionObserver hook
      lib/
        api.ts                       # Go API fetch wrapper (GET/POST with token)
        types.ts                     # TypeScript interfaces (State, Sublocation, Video)
        utils.ts                     # Utility functions
      routes/
        __root.tsx                   # Root layout (LogtoProvider → ThemeProvider → Navbar)
        index.tsx                    # Home page
        callback.tsx                 # Logto sign-in callback handler
        admin.tsx                    # Admin dashboard (Logto-protected)
        contact.tsx                  # Contact form
        locations/
          index.tsx                  # States grid
          $slug.tsx                  # State detail (videos by sublocation)
          $slug.$sublocationSlug.tsx # Sublocation detail (video grid)
    public/                          # Static assets (videos, logos, buttons, ads)
```

### Generated Files — Do NOT Edit

- `web/src/routeTree.gen.ts` — Auto-generated by TanStack Router plugin
- `api/internal/db/*` — Generated by sqlc from `api/sql/queries/`

## Database Schema

3 tables (no users table — Logto handles authentication):

- **states**: `state_id`, `name`, `description`, `slug`, `created_at`, `updated_at`
- **sublocations**: `sublocation_id`, `name`, `description`, `state_id` (FK), `slug`, `created_at`, `updated_at`
- **videos**: `video_id`, `title`, `src`, `type`, `state_id` (FK), `sublocation_id` (nullable FK), `status`, `created_by`, `created_at`, `updated_at`

Slugs are auto-generated by database triggers on INSERT/UPDATE.

## API Endpoints

All endpoints are under `/api/` (nginx strips the prefix before forwarding to Go API).

| Method | Endpoint                         | Description                    | Auth          |
| ------ | -------------------------------- | ------------------------------ | ------------- |
| GET    | `/health`                        | Liveness check                 | None          |
| GET    | `/states`                        | List all states + video counts | None          |
| GET    | `/states/{slug}`                 | Single state by slug           | None          |
| POST   | `/states`                        | Create state                   | Admin (Logto) |
| GET    | `/states/{slug}/sublocations`    | Sublocations for a state       | None          |
| GET    | `/sublocations/{slug}`           | Single sublocation by slug     | None          |
| POST   | `/sublocations`                  | Create sublocation             | Admin (Logto) |
| GET    | `/videos`                        | All active videos              | None          |
| GET    | `/videos?state_id=N`             | Videos by state                | None          |
| GET    | `/videos?sublocation_id=N`       | Videos by sublocation          | None          |
| POST   | `/videos`                        | Create video                   | Admin (Logto) |

### Caching

- GET responses cached in Redis with 5-min TTL
- POST operations invalidate related cache keys (e.g., creating a video invalidates `videos:*` and `states:*`)

## Code Style

### Frontend (Prettier + ESLint)

- No semicolons, single quotes, trailing commas everywhere
- `import type { X }` for type-only imports
- Generic array syntax: `Array<string>` not `string[]`
- Functional components only, default exports for components
- Named exports for route definitions (`export const Route = ...`)
- Tailwind CSS v4 for all styling
- Lucide React for icons

### Go API

- Standard Go formatting (`gofmt`)
- Structured logging via `slog` (JSON output)
- Handler functions return `http.HandlerFunc` closures
- sqlc for type-safe database queries (no hand-written SQL in Go code)

## Dependencies of Note

### Frontend

| Package                  | Purpose                              |
| ------------------------ | ------------------------------------ |
| `@tanstack/react-router` | File-based routing with type safety  |
| `@logto/react`           | Logto OIDC React SDK                |
| `tailwindcss` v4         | Styling                              |
| `lucide-react`           | Icons                                |
| `hls.js`                 | HLS streaming                        |

### Go API

| Package                  | Purpose                              |
| ------------------------ | ------------------------------------ |
| `go-chi/chi/v5`          | HTTP router                          |
| `jackc/pgx/v5`           | PostgreSQL driver (via sqlc)         |
| `redis/go-redis/v9`      | Redis client                         |
| `go-jose/go-jose/v4`     | JWT/JWKS validation                  |
